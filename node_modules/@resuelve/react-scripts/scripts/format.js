'use strict';

const path = require('path');
const paths = require('../config/paths');
const spawn = require('react-dev-utils/crossSpawn');
const yargsParser = require('yargs-parser');
const resolveBin = require('./utils/resolveBin');

const here = p => path.join(__dirname, p);
const hereRelative = p => here(p).replace(process.cwd(), '.');

const args = process.argv.slice(3);
const parsedArgs = yargsParser(args);

const config = ['--config', hereRelative('../config/prettierrc.js')];
const ignore = ['--ignore-path', hereRelative('../config/prettierignore')];

const write = args.includes('--no-write') ? [] : ['--write'];

const filesToApply = parsedArgs._.length
  ? []
  : [`${paths.appSrc}/**/*.+(js|json|less|css|ts|tsx|md)`];

// this ensures that when running format as a pre-commit hook and we get
// the full file path, we make that non-absolute so it is treated as a glob,
// This way the prettierignore will be applied
const relativeArgs = args.map(a => a.replace(`${process.cwd()}/`, ''));

const result = spawn.sync(
  resolveBin('prettier'),
  [...config, ...ignore, ...write, ...filesToApply].concat(relativeArgs),
  { stdio: 'inherit' }
);

process.exit(result.status);
