{"ast":null,"code":"import _objectWithoutProperties from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _regeneratorRuntime from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _toConsumableArray from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _objectSpread from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport _asyncToGenerator from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _defineProperty from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";\n\nvar _TAX_KEY_NAMES,\n    _jsxFileName = \"/Users/usuario-rtd/Desktop/widget-front/src/components/app/views/newInvoice/shared/charges/index.js\";\n\n// Libraries\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport update from 'immutability-helper';\nimport classNames from 'classnames';\nimport accounting from 'accounting';\nimport uuid from 'uuid';\nimport _flatten from 'lodash/flatten'; // Components\n\nimport Button from 'shared/button';\nimport { TAXES } from 'shared/catalogs';\nimport Charge from './charge';\nimport { createCharge, exportTotals, getProduct, getUnit, formatProductOption, formanUnitOption } from '../../utils';\nvar CHARGES_KEY = 'charges';\nvar TOTALS_KEY = 'totals';\nvar TAXES_KEY = 'taxes'; // Tax Detail keys\n\nvar DISCOUNT_CENTS_KEY = 'discount_cents';\nvar SUBTOTAL_CENTS_KEY = 'subtotal_cents';\nvar TOTAL_CENTS_KEY = 'total_cents';\nvar TAX_DETAIL_KEY = 'li_tax_detail_mg';\nvar TAX_RETAINED_ITEMS_KEY = 'li_retained_tax_mgs';\nvar TAX_TRANSFERRED_ITEMS_KEY = 'li_transferred_tax_mgs'; // Sum all taxes from kind (transferred, retained) in charge for tax with taxId\n// Returns a single value that is the total sum of this kind of taxs\n\nvar sumTaxes = function sumTaxes(taxId, taxes, kind) {\n  return taxes.reduce(function (acc, tax) {\n    return acc + tax[kind].filter(function (tax) {\n      return tax['tax_name'] === taxId;\n    }).reduce(function (acc2, tax2) {\n      return acc2 + tax2['amount_cents'];\n    }, 0);\n  }, 0);\n}; // How tax keys are called in\n\n\nvar TAX_KEY_NAMES = (_TAX_KEY_NAMES = {}, _defineProperty(_TAX_KEY_NAMES, TAX_TRANSFERRED_ITEMS_KEY, {\n  id: 'translated',\n  label: 'Trasladado'\n}), _defineProperty(_TAX_KEY_NAMES, TAX_RETAINED_ITEMS_KEY, {\n  id: 'retained',\n  label: 'Retenido'\n}), _TAX_KEY_NAMES); // Return total for taxes in kind catalogs/TAXES\n\nvar getTaxes = function getTaxes(taxes, kind) {\n  return TAXES.filter(function (t) {\n    return t[TAX_KEY_NAMES[kind].id];\n  }).map(function (tax) {\n    return {\n      id: tax['id'],\n      label: \"\".concat(tax['label'], \" (\").concat(TAX_KEY_NAMES[kind].label, \")\"),\n      isPositive: kind === TAX_TRANSFERRED_ITEMS_KEY,\n      amount: sumTaxes(tax['id'], taxes, kind)\n    };\n  });\n};\n\nvar calculateTotals = function calculateTotals() {\n  var charges = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n  var subTotal = 0;\n  var discount = 0;\n  var taxes = [];\n  charges.forEach(function (concept) {\n    taxes.push(concept[TAX_DETAIL_KEY]);\n    subTotal += concept['total_cents'];\n    discount += concept['discount_cents'];\n  });\n  var retainedTaxes = getTaxes(taxes, TAX_RETAINED_ITEMS_KEY);\n  var transferredTaxes = getTaxes(taxes, TAX_TRANSFERRED_ITEMS_KEY);\n  var total = subTotal + discount - retainedTaxes.reduce(function (acc, tax) {\n    return acc + tax['amount'];\n  }, 0) + transferredTaxes.reduce(function (acc, tax) {\n    return acc + tax['amount'];\n  }, 0);\n  return {\n    total: total,\n    subTotal: subTotal,\n    discount: discount,\n    retainedTaxes: retainedTaxes,\n    transferredTaxes: transferredTaxes\n  };\n};\n\nvar Charges =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(Charges, _Component);\n\n  function Charges() {\n    var _this$data;\n\n    var _this;\n\n    _classCallCheck(this, Charges);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(Charges).call(this));\n    _this.loadChanges =\n    /*#__PURE__*/\n    _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee() {\n      var products, units, productOptions, unitsOptions, charges, _calculateTotals, total, subTotal, discount, retainedTaxes, transferredTaxes;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return Promise.all(_this.props.data.map(function (charge) {\n                return charge.product_service_code;\n              }).map(getProduct));\n\n            case 2:\n              products = _context.sent;\n              _context.next = 5;\n              return Promise.all(_this.props.data.map(function (charge) {\n                return charge.unity_code;\n              }).map(getUnit));\n\n            case 5:\n              units = _context.sent;\n              // Format data to be used\n              productOptions = _flatten(products).reduce(formatProductOption, {});\n              unitsOptions = _flatten(units).reduce(formanUnitOption, {});\n              charges = _this.props.data.map(createCharge(productOptions, unitsOptions));\n              _calculateTotals = calculateTotals(charges.map(exportTotals)), total = _calculateTotals.total, subTotal = _calculateTotals.subTotal, discount = _calculateTotals.discount, retainedTaxes = _calculateTotals.retainedTaxes, transferredTaxes = _calculateTotals.transferredTaxes;\n\n              _this.setState(function (state) {\n                var _objectSpread2;\n\n                return _objectSpread({}, state, (_objectSpread2 = {}, _defineProperty(_objectSpread2, TAXES_KEY, [].concat(_toConsumableArray(transferredTaxes), _toConsumableArray(retainedTaxes))), _defineProperty(_objectSpread2, TOTALS_KEY, {\n                  subTotal: subTotal,\n                  discount: discount,\n                  total: total\n                }), _defineProperty(_objectSpread2, CHARGES_KEY, [].concat(_toConsumableArray(state[CHARGES_KEY]), _toConsumableArray(charges.map(function (item) {\n                  return _objectSpread({\n                    uuid: uuid()\n                  }, item);\n                })))), _objectSpread2));\n              });\n\n            case 11:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n    _this.data = (_this$data = {}, _defineProperty(_this$data, CHARGES_KEY, []), _defineProperty(_this$data, TOTALS_KEY, {\n      subTotal: 0,\n      discount: 0,\n      total: 0\n    }), _defineProperty(_this$data, TAXES_KEY, {}), _this$data);\n    _this.state = Object.assign({}, _this.data);\n    return _this;\n  } // Create an empty conpcept on component mount, it's the same as\n  // generating a new concept, but the minumun length of concepts should\n  // always be 1\n\n\n  _createClass(Charges, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      if (!this.props.location.query.invoice) {\n        this.addConcept();\n      }\n\n      if (this.props.data.length > 0) {\n        this.loadChanges();\n      }\n\n      this.updateTotals();\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      if (this.props.recipe !== prevProps.recipe && !this.props.data) {\n        // When recipe changes, delete taxes from all concepts and add them again\n        this.deleteAllCharges();\n      }\n    }\n  }, {\n    key: \"validateAllCharges\",\n    value: function validateAllCharges() {\n      var _this2 = this;\n\n      return this.state[CHARGES_KEY].map(function (charge) {\n        return _this2.refs[charge.uuid].validateRequiredFields();\n      }).every(function (e) {\n        return e;\n      });\n    } // Delete all concepts\n\n  }, {\n    key: \"deleteAllCharges\",\n    value: function deleteAllCharges() {\n      this.setState(_defineProperty({}, CHARGES_KEY, []), this.addConcept);\n    } // Export charges data for outside component retrieval\n\n  }, {\n    key: \"exportCharges\",\n    value: function exportCharges() {\n      var _this3 = this;\n\n      return this.state[CHARGES_KEY].map(function (_ref2) {\n        var uuid = _ref2.uuid;\n        return _this3.refs[uuid].exportCharge();\n      });\n    } // Export totals data for outside component retrieval\n\n  }, {\n    key: \"exportTotals\",\n    value: function exportTotals() {\n      if (this.props.data.length === 0 || this.props.data[0].discount_cents === 0) {\n        var _ref3;\n\n        return _ref3 = {}, _defineProperty(_ref3, DISCOUNT_CENTS_KEY, 0), _defineProperty(_ref3, SUBTOTAL_CENTS_KEY, this.state[TOTALS_KEY].subTotal), _defineProperty(_ref3, TOTAL_CENTS_KEY, this.state[TOTALS_KEY].total), _ref3;\n      } else {\n        var _ref4;\n\n        return _ref4 = {}, _defineProperty(_ref4, SUBTOTAL_CENTS_KEY, this.state[TOTALS_KEY].subTotal), _defineProperty(_ref4, TOTAL_CENTS_KEY, this.state[TOTALS_KEY].total), _ref4;\n      }\n    } // Create a new charge with default values and append it to state\n\n  }, {\n    key: \"addConcept\",\n    value: function addConcept(change) {\n      var id = uuid();\n      this.setState(_defineProperty({}, CHARGES_KEY, [].concat(_toConsumableArray(this.state[CHARGES_KEY]), [{\n        uuid: id\n      }])), this.updateTotals);\n    } // Return a new array with current concepts except the one to be deleted\n\n  }, {\n    key: \"deleteConcept\",\n    value: function deleteConcept(uuid) {\n      this.setState(_defineProperty({}, CHARGES_KEY, this.state[CHARGES_KEY].filter(function (c) {\n        return c.uuid !== uuid;\n      })), this.updateTotals);\n    } // Get totals from every charge, then persist sum of totals and taxes to state\n    // Then notify a parent function that totals have changed\n\n  }, {\n    key: \"updateTotals\",\n    value: function updateTotals() {\n      var _this4 = this,\n          _this$setState4;\n\n      var _calculateTotals2 = calculateTotals(this.state[CHARGES_KEY].map(function (_ref5) {\n        var uuid = _ref5.uuid;\n        return _this4.refs[uuid].exportTotal();\n      })),\n          total = _calculateTotals2.total,\n          subTotal = _calculateTotals2.subTotal,\n          discount = _calculateTotals2.discount,\n          retainedTaxes = _calculateTotals2.retainedTaxes,\n          transferredTaxes = _calculateTotals2.transferredTaxes; // Persist all totals to state\n\n\n      this.setState((_this$setState4 = {}, _defineProperty(_this$setState4, TOTALS_KEY, update(this.state[TOTALS_KEY], {\n        $set: {\n          subTotal: subTotal,\n          discount: discount,\n          total: total\n        }\n      })), _defineProperty(_this$setState4, TAXES_KEY, [].concat(_toConsumableArray(transferredTaxes), _toConsumableArray(retainedTaxes))), _this$setState4), function () {\n        _this4.props.totalChanged(_this4.exportTotals());\n      });\n    } // Render concepts table\n\n  }, {\n    key: \"renderConcepts\",\n    value: function renderConcepts() {\n      var _this5 = this;\n\n      return this.state[CHARGES_KEY].length > 0 && this.state[CHARGES_KEY].map(function (_ref6) {\n        var uuid = _ref6.uuid,\n            data = _objectWithoutProperties(_ref6, [\"uuid\"]);\n\n        return React.createElement(Charge, {\n          key: uuid,\n          ref: uuid,\n          uuid: uuid,\n          deleteConcept: _this5.deleteConcept.bind(_this5),\n          totalUpdated: _this5.updateTotals.bind(_this5),\n          recipe: _this5.props.recipe,\n          deletable: _this5.state[CHARGES_KEY].length > 1,\n          getFrequentlyUsedProducts: _this5.props.getFrequentlyUsedProducts.bind(_this5),\n          getFrequentlyUsedUnits: _this5.props.getFrequentlyUsedUnits.bind(_this5),\n          onValidationError: _this5.props.onValidationError,\n          data: data,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 266\n          },\n          __self: this\n        });\n      });\n    } // Render totals and taxes, updated by changes to concepts\n\n  }, {\n    key: \"renderTotals\",\n    value: function renderTotals() {\n      var _this$state$TOTALS_KE = this.state[TOTALS_KEY],\n          subTotal = _this$state$TOTALS_KE.subTotal,\n          discount = _this$state$TOTALS_KE.discount,\n          total = _this$state$TOTALS_KE.total;\n      var renderTaxes = null;\n\n      if (this.state[TAXES_KEY].length > 0) {\n        renderTaxes = this.state[TAXES_KEY].map(function (tax) {\n          if (tax['amount'] === 0) return null;\n          var amount = tax.isPositive ? accounting.formatMoney(tax['amount'], '') : \"(\".concat(accounting.formatMoney(tax['amount'], ''), \")\");\n          return React.createElement(\"tr\", {\n            key: uuid(),\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 296\n            },\n            __self: this\n          }, React.createElement(\"td\", {\n            className: \"align-left\",\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 297\n            },\n            __self: this\n          }, \"\\xA0\", tax['label'], \":\"), React.createElement(\"td\", {\n            className: \"has-text-right is-money\",\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 301\n            },\n            __self: this\n          }, amount));\n        });\n      }\n\n      return React.createElement(\"div\", {\n        className: \"columns\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 308\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"column is-offset-7\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 309\n        },\n        __self: this\n      }, React.createElement(\"table\", {\n        className: \"table\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 310\n        },\n        __self: this\n      }, React.createElement(\"tfoot\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 311\n        },\n        __self: this\n      }, React.createElement(\"tr\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 312\n        },\n        __self: this\n      }, React.createElement(\"td\", {\n        className: \"align-left\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 313\n        },\n        __self: this\n      }, \"\\xA0SUBTOTAL:\"), React.createElement(\"td\", {\n        className: \"has-text-right is-money\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 314\n        },\n        __self: this\n      }, accounting.formatMoney(subTotal, ''))), React.createElement(\"tr\", {\n        className: classNames({\n          'is-hidden': discount === 0\n        }),\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 318\n        },\n        __self: this\n      }, React.createElement(\"td\", {\n        className: \"align-left\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 319\n        },\n        __self: this\n      }, \"\\xA0DESCUENTO:\"), React.createElement(\"td\", {\n        className: \"has-text-right is-money\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 320\n        },\n        __self: this\n      }, accounting.formatMoney(discount, ''))), renderTaxes, React.createElement(\"tr\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 325\n        },\n        __self: this\n      }, React.createElement(\"td\", {\n        className: \"align-left\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 326\n        },\n        __self: this\n      }, \"\\xA0TOTAL:\"), React.createElement(\"td\", {\n        className: \"has-text-right is-money\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 327\n        },\n        __self: this\n      }, accounting.formatMoney(total, '')))))));\n    } // Main render\n\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(\"div\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 341\n        },\n        __self: this\n      }, React.createElement(\"h2\", {\n        className: \"subheader-green\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 342\n        },\n        __self: this\n      }, \"Conceptos\"), React.createElement(\"div\", {\n        className: \"new-invoice\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 343\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 344\n        },\n        __self: this\n      }, this.renderConcepts()), React.createElement(Button, {\n        buttonStyle: \"primaryLink\",\n        icon: \"plus\",\n        onClick: this.addConcept.bind(this),\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 345\n        },\n        __self: this\n      }, \"Agregar concepto\"), this.renderTotals()));\n    }\n  }]);\n\n  return Charges;\n}(Component);\n\nCharges.propTypes = {\n  data: PropTypes.array,\n  totalChanged: PropTypes.func,\n  onValidationError: PropTypes.func,\n  getFrequentlyUsedProducts: PropTypes.func,\n  getFrequentlyUsedUnits: PropTypes.func,\n  recipe: PropTypes.string,\n  location: PropTypes.shape({\n    query: PropTypes.shape({\n      invoice: PropTypes.string\n    })\n  })\n};\nCharges.defaultProps = {\n  data: [],\n  onValidationError: function onValidationError() {},\n  location: {\n    query: {}\n  }\n};\nexport default Charges;","map":{"version":3,"sources":["/Users/usuario-rtd/Desktop/widget-front/src/components/app/views/newInvoice/shared/charges/index.js"],"names":["React","Component","PropTypes","update","classNames","accounting","uuid","_flatten","Button","TAXES","Charge","createCharge","exportTotals","getProduct","getUnit","formatProductOption","formanUnitOption","CHARGES_KEY","TOTALS_KEY","TAXES_KEY","DISCOUNT_CENTS_KEY","SUBTOTAL_CENTS_KEY","TOTAL_CENTS_KEY","TAX_DETAIL_KEY","TAX_RETAINED_ITEMS_KEY","TAX_TRANSFERRED_ITEMS_KEY","sumTaxes","taxId","taxes","kind","reduce","acc","tax","filter","acc2","tax2","TAX_KEY_NAMES","id","label","getTaxes","t","map","isPositive","amount","calculateTotals","charges","subTotal","discount","forEach","concept","push","retainedTaxes","transferredTaxes","total","Charges","loadChanges","Promise","all","props","data","charge","product_service_code","products","unity_code","units","productOptions","unitsOptions","setState","state","item","Object","assign","location","query","invoice","addConcept","length","updateTotals","prevProps","recipe","deleteAllCharges","refs","validateRequiredFields","every","e","exportCharge","discount_cents","change","c","exportTotal","$set","totalChanged","deleteConcept","bind","getFrequentlyUsedProducts","getFrequentlyUsedUnits","onValidationError","renderTaxes","formatMoney","renderConcepts","renderTotals","propTypes","array","func","string","shape","defaultProps"],"mappings":"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","sourcesContent":["// Libraries\nimport React, { Component } from 'react'\nimport PropTypes from 'prop-types'\nimport update from 'immutability-helper'\nimport classNames from 'classnames'\nimport accounting from 'accounting'\nimport uuid from 'uuid'\nimport _flatten from 'lodash/flatten'\n\n// Components\nimport Button from 'shared/button'\nimport { TAXES } from 'shared/catalogs'\nimport Charge from './charge'\nimport {\n  createCharge,\n  exportTotals,\n  getProduct,\n  getUnit,\n  formatProductOption,\n  formanUnitOption\n} from '../../utils'\n\nconst CHARGES_KEY = 'charges'\nconst TOTALS_KEY = 'totals'\nconst TAXES_KEY = 'taxes'\n\n// Tax Detail keys\nconst DISCOUNT_CENTS_KEY = 'discount_cents'\nconst SUBTOTAL_CENTS_KEY = 'subtotal_cents'\nconst TOTAL_CENTS_KEY = 'total_cents'\n\nconst TAX_DETAIL_KEY = 'li_tax_detail_mg'\nconst TAX_RETAINED_ITEMS_KEY = 'li_retained_tax_mgs'\nconst TAX_TRANSFERRED_ITEMS_KEY = 'li_transferred_tax_mgs'\n\n// Sum all taxes from kind (transferred, retained) in charge for tax with taxId\n// Returns a single value that is the total sum of this kind of taxs\nconst sumTaxes = (taxId, taxes, kind) => {\n  return taxes.reduce(\n    (acc, tax) =>\n      acc +\n      tax[kind]\n        .filter(tax => tax['tax_name'] === taxId)\n        .reduce((acc2, tax2) => acc2 + tax2['amount_cents'], 0),\n    0\n  )\n}\n\n// How tax keys are called in\nconst TAX_KEY_NAMES = {\n  [TAX_TRANSFERRED_ITEMS_KEY]: { id: 'translated', label: 'Trasladado' },\n  [TAX_RETAINED_ITEMS_KEY]: { id: 'retained', label: 'Retenido' }\n}\n\n// Return total for taxes in kind catalogs/TAXES\nconst getTaxes = (taxes, kind) => {\n  return TAXES.filter(t => t[TAX_KEY_NAMES[kind].id]).map(tax => {\n    return {\n      id: tax['id'],\n      label: `${tax['label']} (${TAX_KEY_NAMES[kind].label})`,\n      isPositive: kind === TAX_TRANSFERRED_ITEMS_KEY,\n      amount: sumTaxes(tax['id'], taxes, kind)\n    }\n  })\n}\n\nconst calculateTotals = (charges = []) => {\n  let subTotal = 0\n  let discount = 0\n  let taxes = []\n\n  charges.forEach(concept => {\n    taxes.push(concept[TAX_DETAIL_KEY])\n    subTotal += concept['total_cents']\n    discount += concept['discount_cents']\n  })\n\n  let retainedTaxes = getTaxes(taxes, TAX_RETAINED_ITEMS_KEY)\n  let transferredTaxes = getTaxes(taxes, TAX_TRANSFERRED_ITEMS_KEY)\n\n  let total =\n    subTotal +\n    discount -\n    retainedTaxes.reduce((acc, tax) => acc + tax['amount'], 0) +\n    transferredTaxes.reduce((acc, tax) => acc + tax['amount'], 0)\n  return { total, subTotal, discount, retainedTaxes, transferredTaxes }\n}\n\nclass Charges extends Component {\n  constructor () {\n    super()\n    this.data = {\n      [CHARGES_KEY]: [],\n      [TOTALS_KEY]: {\n        subTotal: 0,\n        discount: 0,\n        total: 0\n      },\n      [TAXES_KEY]: {}\n    }\n    this.state = Object.assign({}, this.data)\n  }\n\n  // Create an empty conpcept on component mount, it's the same as\n  // generating a new concept, but the minumun length of concepts should\n  // always be 1\n  componentDidMount () {\n    if (!this.props.location.query.invoice) {\n      this.addConcept()\n    }\n\n    if (this.props.data.length > 0) {\n      this.loadChanges()\n    }\n\n    this.updateTotals()\n  }\n\n  componentDidUpdate (prevProps) {\n    if (this.props.recipe !== prevProps.recipe && !this.props.data) {\n      // When recipe changes, delete taxes from all concepts and add them again\n      this.deleteAllCharges()\n    }\n  }\n\n  loadChanges = async () => {\n    // avoid coalitions with dispatch events, wait to next tick\n    // await flushPromises()\n\n    // Create an array of ids and Get all products used\n    const products = await Promise.all(\n      this.props.data.map(charge => charge.product_service_code).map(getProduct)\n    )\n\n    // Create an array of ids and get all units used\n    const units = await Promise.all(\n      this.props.data.map(charge => charge.unity_code).map(getUnit)\n    )\n\n    // Format data to be used\n    const productOptions = _flatten(products).reduce(formatProductOption, {})\n    const unitsOptions = _flatten(units).reduce(formanUnitOption, {})\n    const charges = this.props.data.map(\n      createCharge(productOptions, unitsOptions)\n    )\n\n    const {\n      total,\n      subTotal,\n      discount,\n      retainedTaxes,\n      transferredTaxes\n    } = calculateTotals(charges.map(exportTotals))\n\n    this.setState(state => ({\n      ...state,\n      [TAXES_KEY]: [...transferredTaxes, ...retainedTaxes],\n      [TOTALS_KEY]: {\n        subTotal,\n        discount,\n        total\n      },\n      [CHARGES_KEY]: [\n        ...state[CHARGES_KEY],\n        ...charges.map(item => ({ uuid: uuid(), ...item }))\n      ]\n    }))\n  }\n\n  validateAllCharges () {\n    return this.state[CHARGES_KEY].map(charge =>\n      this.refs[charge.uuid].validateRequiredFields()\n    ).every(e => e)\n  }\n\n  // Delete all concepts\n  deleteAllCharges () {\n    this.setState(\n      {\n        [CHARGES_KEY]: []\n      },\n      this.addConcept\n    )\n  }\n\n  // Export charges data for outside component retrieval\n  exportCharges () {\n    return this.state[CHARGES_KEY].map(({ uuid }) =>\n      this.refs[uuid].exportCharge()\n    )\n  }\n\n  // Export totals data for outside component retrieval\n  exportTotals () {\n    if (\n      this.props.data.length === 0 ||\n      this.props.data[0].discount_cents === 0\n    ) {\n      return {\n        [DISCOUNT_CENTS_KEY]: 0,\n        [SUBTOTAL_CENTS_KEY]: this.state[TOTALS_KEY].subTotal,\n        [TOTAL_CENTS_KEY]: this.state[TOTALS_KEY].total\n      }\n    } else {\n      return {\n        [SUBTOTAL_CENTS_KEY]: this.state[TOTALS_KEY].subTotal,\n        [TOTAL_CENTS_KEY]: this.state[TOTALS_KEY].total\n      }\n    }\n  }\n\n  // Create a new charge with default values and append it to state\n  addConcept (change) {\n    const id = uuid()\n\n    this.setState(\n      {\n        [CHARGES_KEY]: [...this.state[CHARGES_KEY], { uuid: id }]\n      },\n      this.updateTotals\n    )\n  }\n\n  // Return a new array with current concepts except the one to be deleted\n  deleteConcept (uuid) {\n    this.setState(\n      {\n        [CHARGES_KEY]: this.state[CHARGES_KEY].filter(c => c.uuid !== uuid)\n      },\n      this.updateTotals\n    )\n  }\n\n  // Get totals from every charge, then persist sum of totals and taxes to state\n  // Then notify a parent function that totals have changed\n  updateTotals () {\n    const {\n      total,\n      subTotal,\n      discount,\n      retainedTaxes,\n      transferredTaxes\n    } = calculateTotals(\n      this.state[CHARGES_KEY].map(({ uuid }) => this.refs[uuid].exportTotal())\n    )\n\n    // Persist all totals to state\n    this.setState(\n      {\n        [TOTALS_KEY]: update(this.state[TOTALS_KEY], {\n          $set: { subTotal, discount, total }\n        }),\n        [TAXES_KEY]: [...transferredTaxes, ...retainedTaxes]\n      },\n      () => {\n        this.props.totalChanged(this.exportTotals())\n      }\n    )\n  }\n\n  // Render concepts table\n  renderConcepts () {\n    return (\n      this.state[CHARGES_KEY].length > 0 &&\n      this.state[CHARGES_KEY].map(({ uuid, ...data }) => (\n        <Charge\n          key={uuid}\n          ref={uuid}\n          uuid={uuid}\n          deleteConcept={this.deleteConcept.bind(this)}\n          totalUpdated={this.updateTotals.bind(this)}\n          recipe={this.props.recipe}\n          deletable={this.state[CHARGES_KEY].length > 1}\n          getFrequentlyUsedProducts={this.props.getFrequentlyUsedProducts.bind(\n            this\n          )}\n          getFrequentlyUsedUnits={this.props.getFrequentlyUsedUnits.bind(this)}\n          onValidationError={this.props.onValidationError}\n          data={data}\n        />\n      ))\n    )\n  }\n\n  // Render totals and taxes, updated by changes to concepts\n  renderTotals () {\n    let { subTotal, discount, total } = this.state[TOTALS_KEY]\n    let renderTaxes = null\n    if (this.state[TAXES_KEY].length > 0) {\n      renderTaxes = this.state[TAXES_KEY].map(tax => {\n        if (tax['amount'] === 0) return null\n        let amount = tax.isPositive\n          ? accounting.formatMoney(tax['amount'], '')\n          : `(${accounting.formatMoney(tax['amount'], '')})`\n        return (\n          <tr key={uuid()}>\n            <td className='align-left'>\n              &nbsp;\n              {tax['label']}:\n            </td>\n            <td className='has-text-right is-money'>{amount}</td>\n          </tr>\n        )\n      })\n    }\n\n    return (\n      <div className='columns'>\n        <div className='column is-offset-7'>\n          <table className='table'>\n            <tfoot>\n              <tr>\n                <td className='align-left'>&nbsp;SUBTOTAL:</td>\n                <td className='has-text-right is-money'>\n                  {accounting.formatMoney(subTotal, '')}\n                </td>\n              </tr>\n              <tr className={classNames({ 'is-hidden': discount === 0 })}>\n                <td className='align-left'>&nbsp;DESCUENTO:</td>\n                <td className='has-text-right is-money'>\n                  {accounting.formatMoney(discount, '')}\n                </td>\n              </tr>\n              {renderTaxes}\n              <tr>\n                <td className='align-left'>&nbsp;TOTAL:</td>\n                <td className='has-text-right is-money'>\n                  {accounting.formatMoney(total, '')}\n                </td>\n              </tr>\n            </tfoot>\n          </table>\n        </div>\n      </div>\n    )\n  }\n\n  // Main render\n  render () {\n    return (\n      <div>\n        <h2 className='subheader-green'>Conceptos</h2>\n        <div className='new-invoice'>\n          <div>{this.renderConcepts()}</div>\n          <Button\n            buttonStyle='primaryLink'\n            icon='plus'\n            onClick={this.addConcept.bind(this)}\n          >\n            Agregar concepto\n          </Button>\n          {this.renderTotals()}\n        </div>\n      </div>\n    )\n  }\n}\n\nCharges.propTypes = {\n  data: PropTypes.array,\n  totalChanged: PropTypes.func,\n  onValidationError: PropTypes.func,\n  getFrequentlyUsedProducts: PropTypes.func,\n  getFrequentlyUsedUnits: PropTypes.func,\n  recipe: PropTypes.string,\n  location: PropTypes.shape({\n    query: PropTypes.shape({\n      invoice: PropTypes.string\n    })\n  })\n}\n\nCharges.defaultProps = {\n  data: [],\n  onValidationError: () => {},\n  location: {\n    query: {}\n  }\n}\n\nexport default Charges\n"]},"metadata":{},"sourceType":"module"}