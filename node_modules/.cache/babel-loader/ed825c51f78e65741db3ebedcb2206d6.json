{"ast":null,"code":"import _objectSpread from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport _regeneratorRuntime from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _toConsumableArray from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _defineProperty from \"/Users/usuario-rtd/Desktop/widget-front/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport moment from 'moment';\nimport get from 'lodash/get';\nimport sortBy from 'lodash/sortBy';\nimport { absolutify } from 'utils';\nimport API from 'api';\nimport SessionStore from 'stores/session';\nimport { VOUCHER_TYPE, INVOICE_KEY, SERIES_KEY, FOLIO_KEY, ISSUE_DATE_KEY, EXCHANGE_RATE_KEY, CURRENCY_KEY, BRANCH_KEY, COMMENTS_KEY, TIME_KEY, RECIPIENT_KEY, RECIPIENT_ID_KEY, CFDI_USAGE_KEY, PAYMENT_FORM_KEY, PAYMENT_METHOD_KEY, FISCAL_ENTITY, FISCAL_RESIDENCY, CHARGE_KEY, AMOUNT_KEY, DESCRIPTION_KEY, UNITY_KEY, PRICE_KEY, DISCOUNT_KEY, TOTAL_KEY, IDENTIFY_NUM_KEY, PRODUCT_SERVICE_CODE_KEY, TAX_DETAIL_KEY, BEFORE_TAX_TOTAL_KEY, CUSTOM_IVA_TRANSLATED, TAX_AMOUNT_CENTS_KEY, TAX_RETAINED_KEY, TAX_TRANSFERRED_KEY, TAX_TAX_NAME_KEY, TAX_RATE_KEY, TAX_FACTORY_TYPE_KEY, TAX_BASE_KEY, RECIPE_DEFAULT_TAX, TAXES_BY_NAME, ISSUER_MG_KEY, TAX_CLASSIFICATION_KEY } from '../constants';\nimport { PAYMENT_CATEGORIES, PAYMENT_METHODS } from 'shared/catalogs';\nexport var PAYMENT_CATEGORIES_SORTED = sortBy(PAYMENT_CATEGORIES, 'hits').reverse();\nexport var AVAILABLE_PAYMENT_METHODS = PAYMENT_METHODS.filter(function (p) {\n  return p.id !== 'PIP';\n}); // Create object with shape valid to request\n\nexport var createIssuer = function createIssuer() {\n  var _INVOICE_KEY, _ref;\n\n  var invoice = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  var issueDate = moment().utc();\n  var voucherType = get(invoice, ['voucher_type'], 'i');\n  return _ref = {}, _defineProperty(_ref, INVOICE_KEY, (_INVOICE_KEY = {}, _defineProperty(_INVOICE_KEY, VOUCHER_TYPE, voucherType === 'i' ? 'I' : 'T'), _defineProperty(_INVOICE_KEY, ISSUE_DATE_KEY, issueDate), _defineProperty(_INVOICE_KEY, SERIES_KEY, get(invoice, ['series'], null)), _defineProperty(_INVOICE_KEY, FOLIO_KEY, null), _defineProperty(_INVOICE_KEY, CURRENCY_KEY, get(invoice, ['currency'], 'MXN')), _defineProperty(_INVOICE_KEY, EXCHANGE_RATE_KEY, get(invoice, ['exchange_rate'], '1.0')), _defineProperty(_INVOICE_KEY, COMMENTS_KEY, get(invoice, ['comments'], '') || ''), _INVOICE_KEY)), _defineProperty(_ref, ISSUER_MG_KEY, _defineProperty({}, TAX_CLASSIFICATION_KEY, SessionStore.getCurrentEntity().tax_classification)), _defineProperty(_ref, BRANCH_KEY, {\n    value: get(invoice, ['branch_id']) ? get(invoice, ['branch_id']) : ''\n  }), _defineProperty(_ref, TIME_KEY, {\n    hour: issueDate.hour(String),\n    minute: issueDate.minute(String)\n  }), _ref;\n}; // Create object with shape valid to request\n\nexport var createRecipient = function createRecipient() {\n  var _INVOICE_KEY2, _RECIPIENT_KEY, _ref2;\n\n  var invoice = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  return _ref2 = {\n    tab: 'sale'\n  }, _defineProperty(_ref2, INVOICE_KEY, (_INVOICE_KEY2 = {}, _defineProperty(_INVOICE_KEY2, PAYMENT_FORM_KEY, get(invoice, ['payment_form'], PAYMENT_CATEGORIES_SORTED[0].id)), _defineProperty(_INVOICE_KEY2, PAYMENT_METHOD_KEY, get(invoice, ['payment_method'], AVAILABLE_PAYMENT_METHODS[0].id)), _INVOICE_KEY2)), _defineProperty(_ref2, RECIPIENT_KEY, (_RECIPIENT_KEY = {}, _defineProperty(_RECIPIENT_KEY, RECIPIENT_ID_KEY, get(invoice, ['recipient', 'rfc'], null) ? {\n    value: get(invoice, ['client_id']),\n    label: get(invoice, ['recipient', 'name'])\n  } : null), _defineProperty(_RECIPIENT_KEY, CFDI_USAGE_KEY, get(invoice, ['recipient', 'cfdi_usage'], 'G01')), _defineProperty(_RECIPIENT_KEY, FISCAL_ENTITY, get(invoice, ['recipient', 'entity_register_id'], '')), _defineProperty(_RECIPIENT_KEY, FISCAL_RESIDENCY, get(invoice, ['recipient', 'tax_residency'], '')), _RECIPIENT_KEY)), _defineProperty(_ref2, \"isValid\", _defineProperty({}, RECIPIENT_KEY, true)), _ref2;\n}; // Return object with taxes calculated\n\nvar formatTax = function formatTax(tax) {\n  var _ref3;\n\n  return _ref3 = {}, _defineProperty(_ref3, TAX_TAX_NAME_KEY, get(tax, ['tax_name'], TAXES_BY_NAME.IVA['id'])), _defineProperty(_ref3, TAX_AMOUNT_CENTS_KEY, get(tax, ['amount_cents'], 0 * 0.106666) / 100), _defineProperty(_ref3, TAX_RATE_KEY, get(tax, ['rate'], 0.16) * 100), _defineProperty(_ref3, TAX_FACTORY_TYPE_KEY, get(tax, ['factory_type'], RECIPE_DEFAULT_TAX['id'])), _defineProperty(_ref3, TAX_BASE_KEY, get(tax, ['base'], 0)), _ref3;\n}; // Create valid object to charge\n\n\nexport var createCharge = function createCharge(productOptions, unitsOptions) {\n  return function () {\n    var _taxDetail, _CHARGE_KEY, _isValid2, _ref4;\n\n    var charge = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    var taxDetail = (_taxDetail = {}, _defineProperty(_taxDetail, TAX_TRANSFERRED_KEY, _toConsumableArray(get(charge, ['tax_detail', 'transferred_taxes'], []).map(formatTax))), _defineProperty(_taxDetail, TAX_RETAINED_KEY, _toConsumableArray(get(charge, ['tax_detail', 'retained_taxes'], []).map(formatTax))), _taxDetail);\n    return _ref4 = {}, _defineProperty(_ref4, CHARGE_KEY, (_CHARGE_KEY = {}, _defineProperty(_CHARGE_KEY, AMOUNT_KEY, get(charge, ['quantity'], 1)), _defineProperty(_CHARGE_KEY, UNITY_KEY, get(charge, ['unity_code']) ? unitsOptions[get(charge, ['unity_code'])] : ''), _defineProperty(_CHARGE_KEY, DESCRIPTION_KEY, get(charge, ['description'], '')), _defineProperty(_CHARGE_KEY, PRICE_KEY, get(charge, ['unit_price_cents'], 0) / 100), _defineProperty(_CHARGE_KEY, TOTAL_KEY, get(charge, ['total_cents'], 0) / 100), _defineProperty(_CHARGE_KEY, DISCOUNT_KEY, get(charge, ['discount_cents'], 0)), _defineProperty(_CHARGE_KEY, IDENTIFY_NUM_KEY, get(charge, ['identify_num'], '')), _defineProperty(_CHARGE_KEY, PRODUCT_SERVICE_CODE_KEY, get(charge, ['product_service_code']) ? productOptions[get(charge, ['product_service_code'])] : ''), _CHARGE_KEY)), _defineProperty(_ref4, TAX_DETAIL_KEY, taxDetail), _defineProperty(_ref4, BEFORE_TAX_TOTAL_KEY, calculateTotal({\n      recipe: 'other',\n      total: get(charge, ['total_cents'], 0),\n      taxes: taxDetail[TAX_TRANSFERRED_KEY],\n      retentions: taxDetail[TAX_RETAINED_KEY]\n    })), _defineProperty(_ref4, \"isValid\", (_isValid2 = {}, _defineProperty(_isValid2, UNITY_KEY, true), _defineProperty(_isValid2, PRODUCT_SERVICE_CODE_KEY, true), _defineProperty(_isValid2, CUSTOM_IVA_TRANSLATED, true), _isValid2)), _ref4;\n  };\n};\nexport var calculateTotal = function calculateTotal(_ref5) {\n  var _ref5$recipe = _ref5.recipe,\n      recipe = _ref5$recipe === void 0 ? '' : _ref5$recipe,\n      _ref5$total = _ref5.total,\n      total = _ref5$total === void 0 ? 0 : _ref5$total,\n      _ref5$taxes = _ref5.taxes,\n      taxes = _ref5$taxes === void 0 ? 0 : _ref5$taxes,\n      _ref5$retentions = _ref5.retentions,\n      retentions = _ref5$retentions === void 0 ? 0 : _ref5$retentions;\n\n  if (recipe === 'sale_with_tax') {\n    var reduceTaxes = function reduceTaxes(tax, i) {\n      return tax + absolutify(i[TAX_AMOUNT_CENTS_KEY]);\n    };\n\n    var transferredTaxes = taxes.reduce(reduceTaxes, 0);\n    var retainedTaxes = retentions.reduce(reduceTaxes, 0);\n    return total - (transferredTaxes + retainedTaxes);\n  }\n\n  return total;\n};\nexport var exportTotals = function exportTotals(charge) {\n  var _ref6;\n\n  return _ref6 = {}, _defineProperty(_ref6, TOTAL_KEY, charge[BEFORE_TAX_TOTAL_KEY] / 100), _defineProperty(_ref6, DISCOUNT_KEY, charge[CHARGE_KEY][DISCOUNT_KEY] / 100), _defineProperty(_ref6, TAX_DETAIL_KEY, charge[TAX_DETAIL_KEY]), _ref6;\n}; // Cache used for invoices with many charges using same units and products\n\nvar cache = {\n  units: {},\n  products: {}\n};\nexport var getProduct =\n/*#__PURE__*/\nfunction () {\n  var _ref7 = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee(productCode) {\n    var _ref8, products;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (!cache.products[productCode]) {\n              _context.next = 2;\n              break;\n            }\n\n            return _context.abrupt(\"return\", Promise.resolve(cache.products[productCode]));\n\n          case 2:\n            _context.next = 4;\n            return API.Invoice.GetProducts({\n              clave_prod_serv: productCode\n            });\n\n          case 4:\n            _ref8 = _context.sent;\n            products = _ref8.products;\n            cache.products[productCode] = products;\n            return _context.abrupt(\"return\", products);\n\n          case 8:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function getProduct(_x) {\n    return _ref7.apply(this, arguments);\n  };\n}();\nexport var getUnit =\n/*#__PURE__*/\nfunction () {\n  var _ref9 = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee2(unitCode) {\n    var _ref10, units;\n\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            if (!cache.units[unitCode]) {\n              _context2.next = 2;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", Promise.resolve(cache.units[unitCode]));\n\n          case 2:\n            _context2.next = 4;\n            return API.Invoice.GetUnits({\n              unit_code: unitCode\n            });\n\n          case 4:\n            _ref10 = _context2.sent;\n            units = _ref10.units;\n            cache.units[unitCode] = units;\n            return _context2.abrupt(\"return\", units);\n\n          case 8:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n\n  return function getUnit(_x2) {\n    return _ref9.apply(this, arguments);\n  };\n}();\nexport var formatProductOption = function formatProductOption(acu, product) {\n  return _objectSpread({}, acu, _defineProperty({}, product.clave_prod_serv, {\n    value: product.clave_prod_serv,\n    label: product.description\n  }));\n};\nexport var formanUnitOption = function formanUnitOption(acu, unit) {\n  return _objectSpread({}, acu, _defineProperty({}, unit.unit_code, {\n    value: unit.unit_code,\n    label: unit.name\n  }));\n};","map":{"version":3,"sources":["/Users/usuario-rtd/Desktop/widget-front/src/components/app/views/newInvoice/utils/index.js"],"names":["moment","get","sortBy","absolutify","API","SessionStore","VOUCHER_TYPE","INVOICE_KEY","SERIES_KEY","FOLIO_KEY","ISSUE_DATE_KEY","EXCHANGE_RATE_KEY","CURRENCY_KEY","BRANCH_KEY","COMMENTS_KEY","TIME_KEY","RECIPIENT_KEY","RECIPIENT_ID_KEY","CFDI_USAGE_KEY","PAYMENT_FORM_KEY","PAYMENT_METHOD_KEY","FISCAL_ENTITY","FISCAL_RESIDENCY","CHARGE_KEY","AMOUNT_KEY","DESCRIPTION_KEY","UNITY_KEY","PRICE_KEY","DISCOUNT_KEY","TOTAL_KEY","IDENTIFY_NUM_KEY","PRODUCT_SERVICE_CODE_KEY","TAX_DETAIL_KEY","BEFORE_TAX_TOTAL_KEY","CUSTOM_IVA_TRANSLATED","TAX_AMOUNT_CENTS_KEY","TAX_RETAINED_KEY","TAX_TRANSFERRED_KEY","TAX_TAX_NAME_KEY","TAX_RATE_KEY","TAX_FACTORY_TYPE_KEY","TAX_BASE_KEY","RECIPE_DEFAULT_TAX","TAXES_BY_NAME","ISSUER_MG_KEY","TAX_CLASSIFICATION_KEY","PAYMENT_CATEGORIES","PAYMENT_METHODS","PAYMENT_CATEGORIES_SORTED","reverse","AVAILABLE_PAYMENT_METHODS","filter","p","id","createIssuer","invoice","issueDate","utc","voucherType","getCurrentEntity","tax_classification","value","hour","String","minute","createRecipient","tab","label","formatTax","tax","IVA","createCharge","productOptions","unitsOptions","charge","taxDetail","map","calculateTotal","recipe","total","taxes","retentions","reduceTaxes","i","transferredTaxes","reduce","retainedTaxes","exportTotals","cache","units","products","getProduct","productCode","Promise","resolve","Invoice","GetProducts","clave_prod_serv","getUnit","unitCode","GetUnits","unit_code","formatProductOption","acu","product","description","formanUnitOption","unit","name"],"mappings":"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","sourcesContent":["import moment from 'moment'\nimport get from 'lodash/get'\nimport sortBy from 'lodash/sortBy'\nimport { absolutify } from 'utils'\nimport API from 'api'\nimport SessionStore from 'stores/session'\n\nimport {\n  VOUCHER_TYPE,\n  INVOICE_KEY,\n  SERIES_KEY,\n  FOLIO_KEY,\n  ISSUE_DATE_KEY,\n  EXCHANGE_RATE_KEY,\n  CURRENCY_KEY,\n  BRANCH_KEY,\n  COMMENTS_KEY,\n  TIME_KEY,\n  RECIPIENT_KEY,\n  RECIPIENT_ID_KEY,\n  CFDI_USAGE_KEY,\n  PAYMENT_FORM_KEY,\n  PAYMENT_METHOD_KEY,\n  FISCAL_ENTITY,\n  FISCAL_RESIDENCY,\n  CHARGE_KEY,\n  AMOUNT_KEY,\n  DESCRIPTION_KEY,\n  UNITY_KEY,\n  PRICE_KEY,\n  DISCOUNT_KEY,\n  TOTAL_KEY,\n  IDENTIFY_NUM_KEY,\n  PRODUCT_SERVICE_CODE_KEY,\n  TAX_DETAIL_KEY,\n  BEFORE_TAX_TOTAL_KEY,\n  CUSTOM_IVA_TRANSLATED,\n  TAX_AMOUNT_CENTS_KEY,\n  TAX_RETAINED_KEY,\n  TAX_TRANSFERRED_KEY,\n  TAX_TAX_NAME_KEY,\n  TAX_RATE_KEY,\n  TAX_FACTORY_TYPE_KEY,\n  TAX_BASE_KEY,\n  RECIPE_DEFAULT_TAX,\n  TAXES_BY_NAME,\n  ISSUER_MG_KEY,\n  TAX_CLASSIFICATION_KEY\n} from '../constants'\n\nimport { PAYMENT_CATEGORIES, PAYMENT_METHODS } from 'shared/catalogs'\n\nexport const PAYMENT_CATEGORIES_SORTED = sortBy(\n  PAYMENT_CATEGORIES,\n  'hits'\n).reverse()\n\nexport const AVAILABLE_PAYMENT_METHODS = PAYMENT_METHODS.filter(\n  p => p.id !== 'PIP'\n)\n\n// Create object with shape valid to request\nexport const createIssuer = (invoice = {}) => {\n  const issueDate = moment().utc()\n  const voucherType = get(invoice, ['voucher_type'], 'i')\n  return {\n    [INVOICE_KEY]: {\n      [VOUCHER_TYPE]: voucherType === 'i' ? 'I' : 'T',\n      [ISSUE_DATE_KEY]: issueDate,\n      [SERIES_KEY]: get(invoice, ['series'], null),\n      [FOLIO_KEY]: null,\n      [CURRENCY_KEY]: get(invoice, ['currency'], 'MXN'),\n      [EXCHANGE_RATE_KEY]: get(invoice, ['exchange_rate'], '1.0'),\n      [COMMENTS_KEY]: get(invoice, ['comments'], '') || ''\n    },\n    [ISSUER_MG_KEY]: {\n      [TAX_CLASSIFICATION_KEY]: SessionStore.getCurrentEntity()\n        .tax_classification\n    },\n    [BRANCH_KEY]: {\n      value: get(invoice, ['branch_id']) ? get(invoice, ['branch_id']) : ''\n    },\n    [TIME_KEY]: {\n      hour: issueDate.hour(String),\n      minute: issueDate.minute(String)\n    }\n  }\n}\n\n// Create object with shape valid to request\nexport const createRecipient = (invoice = {}) => {\n  return {\n    tab: 'sale',\n    [INVOICE_KEY]: {\n      [PAYMENT_FORM_KEY]: get(\n        invoice,\n        ['payment_form'],\n        PAYMENT_CATEGORIES_SORTED[0].id\n      ),\n      [PAYMENT_METHOD_KEY]: get(\n        invoice,\n        ['payment_method'],\n        AVAILABLE_PAYMENT_METHODS[0].id\n      )\n    },\n    [RECIPIENT_KEY]: {\n      [RECIPIENT_ID_KEY]: get(invoice, ['recipient', 'rfc'], null)\n        ? {\n          value: get(invoice, ['client_id']),\n          label: get(invoice, ['recipient', 'name'])\n        }\n        : null,\n      [CFDI_USAGE_KEY]: get(invoice, ['recipient', 'cfdi_usage'], 'G01'),\n      [FISCAL_ENTITY]: get(invoice, ['recipient', 'entity_register_id'], ''),\n      [FISCAL_RESIDENCY]: get(invoice, ['recipient', 'tax_residency'], '')\n    },\n    isValid: {\n      [RECIPIENT_KEY]: true\n    }\n  }\n}\n\n// Return object with taxes calculated\nconst formatTax = tax => ({\n  [TAX_TAX_NAME_KEY]: get(tax, ['tax_name'], TAXES_BY_NAME.IVA['id']),\n  [TAX_AMOUNT_CENTS_KEY]: get(tax, ['amount_cents'], 0 * 0.106666) / 100,\n  [TAX_RATE_KEY]: get(tax, ['rate'], 0.16) * 100,\n  [TAX_FACTORY_TYPE_KEY]: get(tax, ['factory_type'], RECIPE_DEFAULT_TAX['id']),\n  [TAX_BASE_KEY]: get(tax, ['base'], 0)\n})\n\n// Create valid object to charge\nexport const createCharge = (productOptions, unitsOptions) => (charge = {}) => {\n  const taxDetail = {\n    [TAX_TRANSFERRED_KEY]: [\n      ...get(charge, ['tax_detail', 'transferred_taxes'], []).map(formatTax)\n    ],\n    [TAX_RETAINED_KEY]: [\n      ...get(charge, ['tax_detail', 'retained_taxes'], []).map(formatTax)\n    ]\n  }\n\n  return {\n    [CHARGE_KEY]: {\n      [AMOUNT_KEY]: get(charge, ['quantity'], 1),\n      [UNITY_KEY]: get(charge, ['unity_code'])\n        ? unitsOptions[get(charge, ['unity_code'])]\n        : '',\n      [DESCRIPTION_KEY]: get(charge, ['description'], ''),\n      [PRICE_KEY]: get(charge, ['unit_price_cents'], 0) / 100,\n      [TOTAL_KEY]: get(charge, ['total_cents'], 0) / 100,\n      [DISCOUNT_KEY]: get(charge, ['discount_cents'], 0),\n      [IDENTIFY_NUM_KEY]: get(charge, ['identify_num'], ''),\n      [PRODUCT_SERVICE_CODE_KEY]: get(charge, ['product_service_code'])\n        ? productOptions[get(charge, ['product_service_code'])]\n        : ''\n    },\n    [TAX_DETAIL_KEY]: taxDetail,\n    [BEFORE_TAX_TOTAL_KEY]: calculateTotal({\n      recipe: 'other',\n      total: get(charge, ['total_cents'], 0),\n      taxes: taxDetail[TAX_TRANSFERRED_KEY],\n      retentions: taxDetail[TAX_RETAINED_KEY]\n    }),\n    isValid: {\n      [UNITY_KEY]: true,\n      [PRODUCT_SERVICE_CODE_KEY]: true,\n      [CUSTOM_IVA_TRANSLATED]: true\n    }\n  }\n}\n\nexport const calculateTotal = ({\n  recipe = '',\n  total = 0,\n  taxes = 0,\n  retentions = 0\n}) => {\n  if (recipe === 'sale_with_tax') {\n    const reduceTaxes = (tax, i) => tax + absolutify(i[TAX_AMOUNT_CENTS_KEY])\n    const transferredTaxes = taxes.reduce(reduceTaxes, 0)\n    const retainedTaxes = retentions.reduce(reduceTaxes, 0)\n    return total - (transferredTaxes + retainedTaxes)\n  }\n\n  return total\n}\n\nexport const exportTotals = charge => ({\n  [TOTAL_KEY]: charge[BEFORE_TAX_TOTAL_KEY] / 100,\n  [DISCOUNT_KEY]: charge[CHARGE_KEY][DISCOUNT_KEY] / 100,\n  [TAX_DETAIL_KEY]: charge[TAX_DETAIL_KEY]\n})\n\n// Cache used for invoices with many charges using same units and products\nconst cache = {\n  units: {},\n  products: {}\n}\n\nexport const getProduct = async productCode => {\n  if (cache.products[productCode]) {\n    return Promise.resolve(cache.products[productCode])\n  }\n  const { products } = await API.Invoice.GetProducts({\n    clave_prod_serv: productCode\n  })\n\n  cache.products[productCode] = products\n\n  return products\n}\n\nexport const getUnit = async unitCode => {\n  if (cache.units[unitCode]) {\n    return Promise.resolve(cache.units[unitCode])\n  }\n\n  const { units } = await API.Invoice.GetUnits({\n    unit_code: unitCode\n  })\n\n  cache.units[unitCode] = units\n\n  return units\n}\n\nexport const formatProductOption = (acu, product) => ({\n  ...acu,\n  [product.clave_prod_serv]: {\n    value: product.clave_prod_serv,\n    label: product.description\n  }\n})\n\nexport const formanUnitOption = (acu, unit) => ({\n  ...acu,\n  [unit.unit_code]: {\n    value: unit.unit_code,\n    label: unit.name\n  }\n})\n"]},"metadata":{},"sourceType":"module"}